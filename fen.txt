package za.co.standardbank.reference.config;

import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import software.amazon.awssdk.auth.credentials.WebIdentityTokenFileCredentialsProvider;
import software.amazon.awssdk.regions.Region;
import software.amazon.awssdk.services.s3.S3Client;
import software.amazon.awssdk.http.apache.ApacheHttpClient;
import za.co.standardbank.nbp.commons.communication.logging.annotation.ClientApiLog;

import java.time.Duration;

@Slf4j
@ClientApiLog
@Configuration
public class S3Config {

    @Value("${aws.s3.region}")
    private String region;
    private static final int CONNECTION_TIMEOUT = 20000;

    @Bean
    public S3Client s3Client(){

        log.info("Initialising S3 Client(I am Role)");
        S3Client client = S3Client.builder()
                .httpClientBuilder(ApacheHttpClient.builder()
                        .maxConnections(150)
                        .tcpKeepAlive(true)
                        .connectionMaxIdleTime(Duration.ofSeconds(5))
                        .connectionTimeout(Duration.ofSeconds(30)))
                .region(Region.US_WEST_1)
                .credentialsProvider(WebIdentityTokenFileCredentialsProvider.create()).build();
        log.info("S3 client initialised successfully");
        return client;
    }
}
